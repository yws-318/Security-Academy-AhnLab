# 2024.08.05

# 악성코드 분석 필요한 지식
### 기본기
- 컴퓨터 구성요소(CPU, 메모리 구조 등)
- 네트워크 프로토콜 이해
- 다양한 OS(Win, Linux, Mac, Android 등)
- C, C++, Python 등 1개 이상

### 맞춤형 분석 환경 갖추기
- OS 버전, 응용프로그램 버전 등 시나리오 예측하여 환경 구성
- 맞춤형 정적, 동적 분석 도구 구성
- 안티디버깅 기법을 우회하기 위한 가상 환경 구성

</br></br>

# 1. 악성코드 정의 및 유형
## 1.1 악성코드(=Malware)란 무엇인가?
- 악성 소프트웨어의 줄임말
- 악성프로그램이라 불리기도 함(정보통신망법 제48조)
- 악의적인 목적으로 프로그램 및 스크립트 제작 등 모든 코드의 총칭
- 소프트웨어가 실행될 수 있는 모든 기기에서 실행 가능

## 1.2 악성코드 개발 목적
- 국가 안보 위협 및 사회혼란 야기
- 산업기밀 탈취
- 금전적 이득
- 자기 과시욕이 강한 해커의 관심 끌기 유도 등

## 1.3.1 피해 사례
- 악성코드 감염으로 관계자 내부 컴퓨터 해킹 후 미국 송유관 해킹 성공
- 랜섬웨어 악성코드로 매년 평균 약450만다럴 금전적 피해 발생
- 국내 외교,통일,안보 종사자 대상으로 정보 유출형 악성코드 감염 시도
- 대상 서버 내 취약점 확인 후 데이터베이스 내 저장된 성적 정보 획득

보안뉴스, 데일리시큐 등

## 1.4 악성코드 유형
- 2010년 이전에는 주로 바이러스 또는 웜으로 통칭
- 악성코드 발생 행위에 따라 명칭 지정


### 사이버 킬체인(Cyber Kill Chain)이란?
사이버 공격을 각 단계 별 위협 요소파악 및 공격 방법 정의 분석 모델    
공격 단계를 미리 예측하여 공격 효율성 낮추고 피해 최소화 목적

- 정찰 : 이메일, 크롤링, SNS, 사회공학적 기법   
- ☆제작(Weaponization) : 악성코드 생성, Trojan 결합 등
    - C, C++, Python, Ruby 등 다양한 언어로 갭라
- 전달
- 취약점 공격
- 설치
- 명령&제어
- 행동

### 트로이목마(Trojan)
- 정상 프로그램이나 파일로 위장 후 보안망 뚫고 사용자 시스템에 침투
- APT(Advanced Persistent Threat) 공격에 주로 사용
- 다양한 악의적 목적으로 사용 ex) 정보탈취, 시스템 암호화, 봇넷 활용 등

### 백도어(BackDoor)
- 정상적인 인증 우회하여 시스템 내부 침투
- 공격자가 언제든지 시스템에 침투할 수 있도록 비밀 통로 개설 역할
- 로그를 남기지 않는 것이 특징
    - 서버에 저장되어 있는 로그 폴더까지 접근하여 로그 폴더를 삭제한다는 의미
- 다양한 악의적 목적으로 사용 ex) 원격 접근, 은밀한 실행, 자동 실행, 정보 유출 등

### 백도어 악성코드를 이용한 원격 제어
- 공격자가 웹사이트, 이메일 등 다양한 경로를 통해 정상 파일 위장 실행 유도
- 피해자(Victim) 위장 파일 실행 시 PC 악성코드 감염

### 애드웨어(Advertiserment + Software)
- 사용자 동의없이 화면 내 광고가 노출되는 행위
- 광고 게시하여 수익을 얻는 것이 목적
- 프로그램 설치 과정에서 동의를 구한 후 자동 설치
- 웹 페이지 접속 시 상단 또는 하단에 광고 배너가 표시

### 스파이웨어(Spy + Software)
- 사용자 동의없이 개인정보 수집 및 모니터링하는 행위
- 키보드 입력, 인터넷 사용 기록, 신용카드 정보 등 다양하게 정보 수집
- 주로 특정 대상을 타겟팅 후 은밀한 방식으로 악성코드 설치
- 이메일, 메신저, SNS 등 다양한 경로를 통해 설치 유도

### 랜섬웨어
- 컴퓨터 파일 암호화 후 금전적 보상 요구하는 행위
- 기기 취약점을 통해 침투하여 볼륨 쉐도우 카피 정보 손상
- 금전적 보상, 기업 데이터 손상, 정보 유출 등

### 피싱(Phishing)
- 사기 메시지로 사용자를 속이는 행위
- 경계심을 낮춘 후 개인정보 탈취, 협박
- 전자 메일, 문자, SNS, 웹사이트 등 다양한 수단 사용

### 스피어피싱(SpearPhishing)
- 특정 대상을 정하여 사기 메시지로 사용자를 속이는 행위
- 전자 메일, 문자, SNS, 웹사이트 등 다양한 수단 사용
    - 1. 대학 교수를 사잉, 강의 요청 관련 메일로 위장
    - 2. 답변 시 2차 메일로 첨부파일 위장 링크 삽입
    - 3. 피해자 보안 경계 낮추기 위해 보안메일 위장
    - 4. 피싱사이트 내 계쩡정보 입력 유도

### 취약점 공격(Exploit)
- 타겟 장비가 가지고 있는 취약점으로 침투하는 행위
- 취약점 공격 성공 시 엑세스 확보 및 시스템 제어
- 시스템 제어, 원격 코드 실행, 추가 악성코드 삽입 등

# 2. 악성코드 분석 방법론

## 평판 조회 사이트 활용
- 전세계 백신 업체 엔진을 한 곳에 모아 확인 가능
- 악성코드 및 악성 URL 업로드 시 스캔 엔진으로 결과 도출
- Virustotal.com, Hybrid-Analysis.com 등
    - 우리 회사 타겟 프로그램, 프로젝트 진행 중 파일, APT 공격이 의심되는 파일을 
    - 이런 사이트에 함부로 올리면 안된다.

## 악성코드 자동 분석 사이트 활용
- 악성코드 및 악성URL 을 온라인 환경에서 안전하게 실행
- 영엽별로 상세한 스냅샷으로 구간별 악성코드 행위 확인 가능
- JoeSandbox, Any.Run 등
```
간단 분석       정적 속성 분석          동적 자동화 분석

상세 분석       코드 역공학 분석        대화형 동적 분석
                    비실행                   실행
```
**정적 속성 분석 :**   
처음엔 악성코드 동작하지 않고 분석하는 영역

**동적 자동화 분석 :**   
동작하고 하나하나 행위 관찰하는 영역

**코드 역공학 분석 :**    
굳이 동작을 시키지 않고 확인하는 영역   
어떤 코드로 악성코드가 구성되어 있는지 확인    
IDA 분석 도구.    
어셈블리 레벨에서 코드 하나하나 관찰할 수 있음   

**대화형 동적 분석 :**   
코드 리버싱을 실제 동작하면서 트레이싱 하는 방법



파일 분석 - 증상 분석 - 정보 분석 - 코드 분석 - 패턴 분석

파일 분석
- 파일 형태 분석
- API 분석
- Sting 분석

증상 분석
- 파일시스템 분석
- 프로세스 분석
- 레지스트리 분석
- 네트워크 분석
- 기타 분석

정보 분석
- 증상 추가 분석
- 각종 정보 수집
- 관련사항 확인

코드 분석
- 퍼알 디스어셈블리
- 디버깅 후 역분석

패턴 제작
- 악성코드 판단
- 진단 시그니처 및 함수 제작
- 상세 분석보고서 작성


### 정적 분석 정의
- 악성코드를 실행하지 않는 상태에서 분석
- 헤더 정보와 내부 문자열, 실행 합축 여부, 등록 정보 등을 통하여 동작을 파악
- 디스어셈블러를 이용하여 내부 코드와 구조를 확인 후 연관성 파악

### 동적 분석 정의
- 악성코드를 직접 실행하여 행위를 관찰
- 파일, 레지스트리, 네트워크 등을 확인하며 동작 행위를 분석
- 디버깅을 통해 코드 흐름과 메모리 상태를 직접 확인

## 2.1 정적 분석

### 2.1.1 컴파일 정보 확인
- 악성코드 개발 언어 확인 필수(C/C++, JAVA, Python, Go 등)
    - Detect it Easy 프로그램
- 컴파일러 정보 확인해야 다음 스텝으로 이동 가능
- Window, Linux, Mac, Android 등 다양한 OS 환경에 맞춤형 실행파일로 악성코드 제작
- 모든 파일에는 시그니처(= Magic Number) 존재, 역시 필수 확인
    - 윈도에서 실행가능한 모든 P 파일은 고유 시그니처를 다 가지고 있다   
      윈도우에서 자체적으로 품고있는 파일만 해당 시그니처 갖고 있음
        - 4d 5a (= 윈도우에서 실행가능한 파일이구나!)

### 2.1.2 실행압축(Packing) 여부 확인
- 개발자 코드를 역으로 분석하지 못하게 하기 위한 목적
- 악성코드 제작자가 악성코드 분석을 방해하기 위해 자신만의 알고리즘으로 압축   
ex) UPX, VMprotect, Thimida 등
- 분석가는 실행압축 확인 후 오픈 소스 등을 활용하여 압축 해제 후 분석

### 2.1.3 문자열(String) 확인
- 악성코드 Binary -> ASCII 변환 시 가독성 있는 문자열 확인
- 어떤 행위를 할 것인가에 대한 사전 예측 시 중요 단서가 될 수 있음
- 최근 실행 압축, 프로텍트 등을 통해 문자열 마저 보호되어 분석 방해

### 2.1.4 파일 무결성 확인
- 정상 파일을 위장한 악성코드인지 확인 필요
- 암호화 알고리즘(MD5, SHA, AES 등) 통해 파일 고유 식별 정보 확인
- 전세계쩍으로 악성코드 Database 내 공통 식별하기 위해 사용
    - HashMyFiles
파일 이름이 달라도 Hash 값이 같다면?    
동일한 악성코드다 라고 확인 가능

## 2.2 동적 분석

### 2.2.1 프로세스 변화 관찰
- 모든 악성코드 행위에는 프로세스가 동작
- 시스템 내 발생하는 실시간 프로세스 변화에 대해 분석 필요
- 부모와 자식 프로세시 연결 고리, 코드 인젝션, 명령어 실행 등

### 2.2.2 파일 시스템 변화 관찰
- OS 내 현재 동작 중인 파일 상태 실시간 확인
- 기존 파일 수정, 삭제 또는 새로 파일 생성 등
- 악성코드 실행 후 파일시스템 내 변화 체크 매우 중요

### 2.2.3 레지스트리 변화 관찰
- 시스템 레지스트리 조작하여 원하는 정보 입력 가능
- 중요 레지스트리 삭제 후 보안 설정 우회 등 다양하게 활용
- 악성코드 주요 레지스트리 변경 여부 확인 중요

### Process Moniter 도구 ☆
- 프로세스의 레지스트리, 파일, 프로세스/스레드, 네트워크 동작 등을 실시간으로 캡처하는 프로그램
- 레지스트링 활동, 파일 시스템 활동, 네트워크 활동, 프로세스와 스레드 활동, 이벤트 프로파일링 등 모니터링 기능을 지원
- ### 옵션 정보
    - capture : 현재 상태 캡처
        - 한 번 누르면 활성화
            - 1부터 몇천만까지 다 로그를 찍겠다
        - 한 번 더 누르면 비활성화
    - autoscroll : 최근 활동한 프로세스 목록 이동
    - clear : 프로세스 출력 내용 삭제
        - 지우개 모양. 
    - Filter : 해당 프로세스만 sorting해서 볼 수 있음
        - 제일 많이 사용. 
    - Highlight : 강조할 프로세스 표시
- ☆Filter 옵션을 이용하여 특정 프로세스에 대한 정보만 필터링하여 확인 가능
    - 필터 거는 방법
        - Filter 메뉴.
        - Process Name
        - svchost.exe
        - Include
        - OK
    - Tools - Process Tree
        - Process Explorer 에는 악성코드가 자가종료를 하면 안보임.   
        근데, Process Tree는 로그를 다 찍는 것이기 때문에 자가 종료가 되어도 관찰 가능
    - Options - Enable Boot Logging - OK
        - OK 눌러서 활성을 해주면
        - 가상머신 재부팅 후 가상머신이 load가 되면    
        CMOS부터 커널단에서부터 윈도우 시작하는 과정들이 다 log가 나옴.   
        악성코드가 재부팅을 했을 때 어떻게 동작하는지 다 관찰이 가능함.

Process Monitor 프로그램

주로 악성코드가 레지스트리 건드리는 목적은 :     
1.지속성    
2.바꿔치기할려고 접근   

윈도우 디펜더 기능을 레지스트리에서 value 값 조정을 통해서 건드릴 수 있음.   
악성코드 중에서는 디펜더 기능을 뚫기 위해 권한을 레지스트리에서 변경하는 경우가 있음.    

Process Monitor 에 어떻게 필터를 걸어야    
악성코드만 볼 수 있는지....

### 2.2.4 네트워크 변화 관찰
- 최근 악성코드는 정보 수집 및 추가 파일 업로드 위해 네트워크 이용
- 공격자 서버(=C&C서버) 통신 실시간 확인 필요
- 피해자 정보 외부 유출, 악성파일 추가 다운로드 등 네트워크 행위 확인

Wireshark.   
요즘 악성코드는 네트워크 행위를 다 하기 때문에   
<U>**네트워크 행위를 꼭 관찰해야 함.**</U>    
악성코드를 메모리에 올리기 전에 네트워크 행위를 관찰해야 함.

### 2.2.5 API 실행 변화 관찰
- API는 응용프로그램 제어 가능 인터페이스 집합
- 악성코드 실행될 때 사용되는 API 함수 확인 가능
- 수많은 API 함수 존재, 기능 확인 필요시... 


### 역공학 분석
- 저급(어셈블리) 언어 영역에서 악성코드를 역으로 분석하는 기법
- 악성코드 기능을 상세하게 분석하여 확인 가능
- 역공학 분석 방지를 위해 프로텍트, 패킹, 로더 등 다양한 방법으로 분석가 방해

여기까지 분석을 할 줄 안다면 악성코드 분석가로서 활동 가능

---

### 지속성 유지 확인
- 악성코드가 일회성인지 지속적으로 동작하는지 확인 필요
- 일반적인 악성코드는 지속성 유지하기 위한 행위를 내제하고 있음
- Autoruns를 통해 시작프로그램, 작업스케줄러, 서비스 등 지속성 유지 행위 확인 가능

### PEStudio 활용
- 윈도우 OS용 악성코드는 전세계 약 65% 비중 차지
- PEStudio는 윈도우 실행 파일 전용 정적 분석 도구
- 평판 사이트 결과, 문자열, Hash값, PE 구조 등 다양한 정보 확인 가능

### Thunderbird 활용
- 전세계 악성코드 80%이상 전자메일을 통해 유포
- 메일 샘플링 후 공격자 정보, 악성코드 유포지, 악성파일 등 다양한 정보 확인 가능

## 3. 분석 환경 구성 및 도구 실습

### 3.1 가상 환경 이해
- 소프트웨어로 실제 컴퓨터 환경처럼 이미지 파일 구성
- 하드웨어 리소스 적절히 분리하여 하나의 OS에서 여러 개 OS 사용 가능    
※ 멀티 부팅과는 다른 개념
- 악성 코드를 분석하기 위해 다양한 OS 환경 구축 중요

### 3.2 가상 환경 구성
- 호스트PC 내 가상 소프트웨어 다운로드 및 설치
- OS 다운로드 및 설치, 가급적 OS 버전별, 종류별로 다양하게 설치
- 악성코드 구동 가능한(취약한) 환경 구성(중요)
    - OS 패치 미적용
    - 안티바이러스 미설치
    - 윈도우 디팬더 기능 해제
- 분석가 입맛에 맞게 악성코드 분석 도구 세팅
- 모든 과정을 마치면 기본 스냅샷 저장 필수(중요)
    - 악성코드 분석 과정에서 '실행전', '실행중', '실행후' 모든 과정에서 스냅샷 습관 들이기


※ Guest PC에 악성코드를 실행시켰는데?    
Host PC까지 악성코드에 감염되는 경우가 있음.     
-> Guest PC와 Host PC 사이 파일 공유할 때 드래기 앤 드롭을 하지 않고   
공유폴더를 뚫어서 파이프라인을 하나 뚫어버리면 그곳을 통해서 다 악성코드 감염

### 3.3 분석 도구 실습
- 정적 분석 도구 설치 및 실습
- 동적 분석 도구 설치 및 실습

## 5. 악성코드 분석 도구 활용 방안
### Process Explorer 도구 인터페이스
- 프로세스의 속성을 확인할 떄는 특정 프로세스를 우클릭하여 속성 확인 [Properties...]
- 속성 정보에는 네트워크 연결정보, 쓰레드, 문자열 등 다양한 정보 확인 가능

Process Explorer   
속성정보를 들어가서
1. 해당 파일의 경로를 확인함.   
2. TCP/IP 탭에서 네트워크에서 어떤 행위를 하는지 확인    
3. String 탭에 들어가서 String 값을 확인

최근 악성코드들의 path 경로를 보니까   
Temp 폴더에 은엄폐를 많이 하더라...   
Temp 폴더에 있으면 악성으로 간주하는 경우가 많음

## 실습

## 동적 분석
```
die.exe 파일 켜서   
setup 파일 올려보면   
![alt text](image.png)   
인스톨러가 있는 거 보니까   
윈도우에서 동작하는 인스톨러겠구나! 유추 가능   

hashmyfiles 열어서
![alt text](image-1.png)

droper라고 하니까 뭔가 유추할 수 있다고 함.

익스플로러에서 확인해보니까 안나옴

프로세스 모니터 프로그램 열어서
setup 파일 열어봄
tools-tree 들어가면 확인가능
![alt text](image-2.png)

svchost.exe 우클릭 - go to Event (그 이벤트 당시로 가겠다) - include Filter

우측상단 5개 아이콘 중에서 show process and thread activity 제외하고 다 끔    
읽어보면 cmd라는 프로세스를 동작시키면서 인자값으로 c를 두고 작업스케줄러를 등록하는 행위를 함.

/sc minute  등등 이런 명령어가 스케줄러를 등록한다는 의미.
아 그럼 지속성을 유지하기 위해 작업스케줄러를 등록하는 작업을 하고 있구나


커맨드 창에서 작업스케줄러 등록했는지 여부를 확인해보자

윈도우에서 작업스케줄러 검색

svchost.exe 파일이 원래 윈도우 폴더 밑에 있어야 하는데
ucsc 폴더 밑에 있다는 걸 보고 이상하다고 느껴야 함.   

실제로 그 폴더로 들어가보면    
오늘 날자로 svchost.exe 파일이 생성이 된 걸 확인할 수 있음.    
뭔가 의심이 간다.

monitor에서 어떤 동작을 했는지 면밀하게 관찰이 가능함

이제 우측상단 show process and thread activity 해제하고    
file system 킴
이 파일이 별도로 파일을 설치한 과정은 없음.    
그럼 다시 tree로 가서 어떤 일을 하는지 다시 확인해보자

unrar.exe 파일을 실행했네   
클릭해서 하단 command를 확인해보니까   
tmp 폴더에 어떤 걸 압축해제 했구나 라고 확인이 가능함    
그럼 실제로 파일이 존재하는지 확인해봄    

실제로 존재함.
그럼 이 unrar.exe 파일은 악성코드인가? 
hashfile 프로그램에서 다시 hash값 찾아서 검색 사이트에 찾아보니까?   
딱히 악성프로그램은 아님

그럼 unrar.exe 파일은 문제가 없고   
svchost.exe 파일에 포커스를 맞춰야 함

svchost.exe 파일을 다시 hasf값을 추출해서 바이러스토탈에 올려보니까    
죄다 빨간색으로 나옴.    
이 파일이 문제가 있다는 것을 확인할 수 있음    
backdoor, trojan으로 보고 있다고 나옴.   
그럼 이 파일이 악성코드일 가능성이 높겠구나 라고 확인이 가능함
```
